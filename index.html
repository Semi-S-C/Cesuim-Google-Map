<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>3D卫星地图</title>
  <script src="Cesium/Cesium.js"></script>
  <link href="Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100vh; font-family: Arial, sans-serif;
      background-color: #f0f0f0;
    }
    #container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    /* 左侧导航栏 */
    #sidebar {
      width: 130px;
      background-color: #0d1b2a;
      color: white;
      transition: width 0.3s ease;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #sidebar.collapsed {
      width: 60px;
    }
    #sidebar header {
      padding: 20px;
      font-size: 1.5em;
      text-align: center;
      border-bottom: 1px solid #0d1b2a;
    }
    #sidebar nav {
      flex: 1;
      padding: 10px;
    }
    #sidebar nav a {
      display: block;
      padding: 10px 15px;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #sidebar nav a:hover {
      background-color: #0d1b2a;
    }

    #sidebar nav a {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .icon {
      display: inline-block;
      width: 24px;
      text-align: center;
      font-size: 18px;
    }

    .text {
      display: inline-block;
      transition: opacity 0.3s ease;
      white-space: nowrap;
    }

    #sidebar.collapsed .text {
      display: none;
    }


    #toggleBtn {
      background-color: #0d1b2a;
      border: none;
      color: white;
      cursor: pointer;
      padding: 10px;
      font-size: 1.2em;
    }
    #topbar {
      width: 100%;
      height: 60px;
      background: linear-gradient(to right, #0d1b2a, #1b263b);
      color: #00cfff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1em;
      padding: 0 40px;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.6);
      font-family: "Microsoft YaHei", sans-serif;
    }

    .left-tabs {
      display: flex;
      gap: 10px;
    }

    .left-tabs span {
      margin-right: 20px;
      padding: 6px 14px;
      background: rgba(0, 128, 255, 0.2);
      border: 1px solid #00cfff;
      border-radius: 8px;
      color: #00cfff;
      font-weight: bold;
      cursor: pointer;
    }

    .left-tabs span:hover {
      background: rgba(0, 128, 255, 0.4);
    }

    .top-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.6em;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 0 0 6px #00cfff;
      pointer-events: none; /* 可选：避免遮挡点击 */
    }

    .right-time {
      position: absolute;
      left: 85%;
      font-size: 1.3em;
      color: #ffffff;
      text-shadow: 0 0 6px #00cfff;
    }

    #container {
      padding-top: 60px;
    }
    /* 中间地图区域 */
    #main {
      flex: 1;
      background-color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    /* 右侧栏 */
    #rightbar {
      width: 200px;
      background-color: #ecf0f1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }


    /* 地图容器 */
    #map {
      width: 100%;
      height: 100%;
      border: 2px solid #7f8c8d;
      border-radius: 8px;
      box-shadow: 0 0 10px #7f8c8d;
    }

    #customPopup {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      display: none;
      z-index: 10000;
      max-width: 250px;
    }
    #customPopup button.closeBtn {
      background: transparent;
      border: none;
      color: white;
      font-weight: bold;
      float: right;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div id="topbar">
  <div class="top-title">列车运行安全环境智能监控平台</div>
  <div class="right-time" id="topTime">2025-07-24 14:18:06</div>
</div>
<div id="container">
  s<aside id="sidebar">
    <header>导航栏</header>
    <nav>
      <a href="index.html">首页</a>
      <a href="monitor.html">视频监控</a>
      <a href="analysis.html">数据分析</a>
      <a href="settings.html">消息审核</a>
      <a href="help.html">帮助</a>
    </nav>
    <button id="toggleBtn" title="折叠/展开导航栏">></button>
  </aside>

  <main id="main">
    <div id="map"></div>
  </main>
</div>
<div id="customPopup">
  <button class="closeBtn" onclick="document.getElementById('customPopup').style.display='none'">×</button>
  <div id="popupContent"></div>
</div>
<script>
  // 多次延迟刷新地图尺寸函数，避免显示异常
  function refreshMapSize() {
    viewer.resize();  // Cesium 的更新方法
  }

  //  3D地图

  Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1NTU0YWIzOS0xMzY5LTQyOTUtYWFkMi0yMDNiZWJlMjczMTIiLCJpZCI6MzA5NDYyLCJpYXQiOjE3NDkxMTIxMjB9.7o1Yp55GQJLpYIBvcPA7IaeuzRudrxkVqe8WZ1t4CjY';
  //
  const viewer = new Cesium.Viewer('map', {
    terrainProvider: new Cesium.EllipsoidTerrainProvider(),  // 无需联网
    //terrainProvider: Cesium.createWorldTerrain(),  // 高精度地形，联网加载
    shouldAnimate: true,
  });

 // // 离线地图
 //  const viewer = new Cesium.Viewer('map', {
 //    terrainProvider: new Cesium.EllipsoidTerrainProvider()  // 或你的地形提供者
 //  });
 //
 //  // 加载本地离线瓦片影像
 //  const offlineImagery = new Cesium.UrlTemplateImageryProvider({
 //    url: 'http://192.168.0.19:8001/{z}/{x}/{y}.png',  // 本地瓦片路径
 //    maximumLevel: 18,
 //    minimumLevel: 5,
 //    credit: '离线瓦片地图'
 //  });
 //
 //  viewer.imageryLayers.addImageryProvider(offlineImagery);
 //
 //  const tileset = viewer.scene.primitives.add(
 //          await Cesium.Cesium3DTileset.fromIonAssetId(96188),
 //  );



  Cesium.GeoJsonDataSource.load('export_11.geojson', {
    stroke: Cesium.Color.fromCssColorString('#e8f60d').withAlpha(0.6), // 半透明黄绿色
    strokeWidth: 5,
    clampToGround: true
  }).then(function (dataSource) {
    viewer.dataSources.add(dataSource);
    viewer.flyTo(dataSource);

    // 遍历 features，手动加标签
    const entities = dataSource.entities.values;
    for (let i = 0; i < entities.length; i++) {
      const entity = entities[i];
      if (entity.position && entity.properties && entity.properties.name) {
        // 删除默认的点（如果存在）
        entity.point = undefined;
        entity.billboard = new Cesium.BillboardGraphics({
          image: 'marker-icon-red.png',
          width: 25,
          height: 41,
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          scale: 1.0,
          eyeOffset: new Cesium.Cartesian3(0, 0, -10), // 控制图标在相机方向上的偏移（防遮挡）
          horizontalOrigin: Cesium.HorizontalOrigin.CENTER, // 水平居中（默认）
          scaleByDistance: new Cesium.NearFarScalar(40000, 1, 100000, 0.3), // 距离越远图标越小
        });

        // 添加标签
        entity.label = new Cesium.LabelGraphics({
          text: entity.properties.name.getValue(),
          font: '10pt sans-serif',
          fillColor: Cesium.Color.WHITE,
          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          outlineWidth: 2,
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          pixelOffset: new Cesium.Cartesian2(0, 10), // 标签往上偏移一些，避免和图标重叠
        });
      }
    }

  });


  ////////

  const markerData = [
    {
      name: "K8+752～+800(羽四嶺隧道）",
      lon: 108.271942,
      lat: 22.726814
    },
    {
      name: "K58+502(火炭岭隧道北头)",
      lon: 108.41925,
      lat: 22.393368
    },
    {
      name: "K59+777（狮子尾1号隧道北头）",
      lon: 108.429832,
      lat: 22.387316
    },
    {
      name: "K60+040～+120(狮子尾1号隧道南头)",
      lon: 108.432709,
      lat: 22.384842
    },
    {
      name: "K60+680（三甲隧道北头）",
      lon: 108.436302,
      lat: 22.382336
    }


    // 可以继续添加更多点
  ];

  markerData.forEach((item) => {
    viewer.entities.add({
      name: item.name,
      position: Cesium.Cartesian3.fromDegrees(item.lon, item.lat),
      billboard: {
        image: 'marker-icon.png',
        width: 25,
        height: 41,
        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
        scaleByDistance: new Cesium.NearFarScalar(1000, 1.0, 20000, 0.3),
      },
      // label: {
      //   text: item.name,
      //   font: '14pt sans-serif',
      //   fillColor: Cesium.Color.WHITE,
      //   style: Cesium.LabelStyle.FILL_AND_OUTLINE,
      //   outlineWidth: 2,
      //   verticalOrigin: Cesium.VerticalOrigin.TOP,
      //   pixelOffset: new Cesium.Cartesian2(0, -40)
      // }
    });
  });


  viewer.entities.add({
    name: "K60+680（三甲隧道北头）",
    position: Cesium.Cartesian3.fromDegrees(108.436302, 22.382336),
    billboard: {
      image: 'marker-icon.png',
      width: 25,
      height: 41,
      verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
      // scaleByDistance: new Cesium.NearFarScalar(1000, 1.0, 20000, 0.3),
    },
    description: `
    <h3>K60+680（三甲隧道北头）</h3>
    <p><b>里程:</b> K60+680</p>
    <p><b>查看详情:</b>
      <a href="ObservationPointDetails.html" target="_blank">
        点击打开详情页
      </a>
    </p>
  `
  });


  //
  // 假设已有 Cesium.Viewer 对象 viewer
  const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
  const popup = document.getElementById('customPopup');
  const popupContent = document.getElementById('popupContent');

  handler.setInputAction(function(click) {
    const pickedObject = viewer.scene.pick(click.position);
    if (Cesium.defined(pickedObject) && pickedObject.id) {
      const entity = pickedObject.id;

      // 这里取实体名或者自定义属性
      const name = entity.name || '无名实体';
      // 你可以根据实体附加的属性拼接详情信息
      const description = entity.description || '';

      popupContent.innerHTML = `
        <h3>${name}</h3>
        <div>${description}</div>
        <p><a href="ObservationPointDetails.html" target="_blank">查看详情</a></p>
      `;

      // 弹窗位置放到点击点附近，偏移量根据需求调整
      popup.style.left = (click.position.x + 10) + 'px';
      popup.style.top = (click.position.y + 10) + 'px';

      popup.style.display = 'block';
    } else {
      popup.style.display = 'none';
    }
  }, Cesium.ScreenSpaceEventType.LEFT_CLICK);







  // 视角跳转到起点
  // viewer.flyTo(railway);

  // 视角飞到点的位置
  viewer.zoomTo(viewer.entities);







  // 导航栏折叠/展开功能
  const sidebar = document.getElementById('sidebar');
  const toggleBtn = document.getElementById('toggleBtn');
  toggleBtn.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    toggleBtn.textContent = sidebar.classList.contains('collapsed') ? '<<' : '>';

    refreshMapSize();
  });

  //
  function updateTopTime() {
    const now = new Date();
    const formatted = now.toLocaleString('zh-CN', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: false
    }).replace(/\//g, '-');
    document.getElementById('topTime').textContent = formatted;
  }
  updateTopTime();
  setInterval(updateTopTime, 1000);

</script>
</body>
</html>
